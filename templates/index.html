{% extends "base.html" %}

{% block content %}
<section class="hero">
    <div class="container">
        <h1 class="hero-title">Academics can be surprisingly expensive</h1>
        <p class="hero-subtitle">Track required books, find cheaper alternatives, and manage your semester budget</p>
    </div>
</section>

<section class="features">
    <div class="container">
        <div class="features-grid">
            <div class="feature">
                <h3>Track Required Books</h3>
                <p>Organize textbooks by class and semester. Keep track of what you need and what you have.</p>
            </div>
            <div class="feature">
                <h3>Find Alternatives</h3>
                <p>Discover cheaper options: used books, rentals, PDFs, and international editions. Save up to 70%.</p>
            </div>
            <div class="feature">
                <h3>Budget Estimator</h3>
                <p>Plan your expenses before the semester starts. Get estimates and optimize your spending.</p>
            </div>
            <div class="feature">
                <h3>Supplies Checklist</h3>
                <p>Essential supplies checklist for each semester. Never forget what you need.</p>
            </div>
            <div class="feature">
                <h3>Student Marketplace</h3>
                <p>Buy and sell textbooks directly with other students. Save money, help peers.</p>
            </div>
        </div>
    </div>
</section>

<section class="planner-section">
    <div class="container">
        <div class="section-header">
            <h2>Your Classes</h2>
            <button class="btn btn-primary" onclick="showAddClassModal()">Add Class</button>
        </div>

        <div id="budgetSummary" class="budget-summary">
            <div class="budget-item">
                <span class="budget-label">Total Cost</span>
                <span class="budget-value" id="totalCost">$0.00</span>
            </div>
            <div class="budget-item">
                <span class="budget-label">Textbooks</span>
                <span class="budget-value" id="textbookCost">$0.00</span>
            </div>
            <div class="budget-item">
                <span class="budget-label">Supplies</span>
                <span class="budget-value" id="supplyCost">$0.00</span>
            </div>
        </div>

        <div id="classesList" class="classes-list"></div>

        <div class="supplies-section">
            <h3>Semester Supplies Checklist</h3>
            <div id="suppliesChecklist" class="supplies-checklist"></div>
        </div>
    </div>
</section>

<!-- Add Class Modal -->
<div id="addClassModal" class="modal" style="display: none;">
    <div class="modal-overlay" onclick="closeModal()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add Class</h2>
            <button class="modal-close" onclick="closeModal()">×</button>
        </div>
        <form id="addClassForm" class="modal-form">
            <div class="form-group">
                <label>Class Name</label>
                <input type="text" id="modalClassName" required>
            </div>
            <div class="form-group">
                <label>Semester</label>
                <input type="text" id="modalSemester" required placeholder="e.g., Fall 2025">
            </div>
            <div class="form-group">
                <label>Textbooks</label>
                <div id="textbooksContainer" class="items-container">
                    <div class="item-row">
                        <input type="text" placeholder="Textbook name" class="item-name" required>
                        <input type="number" placeholder="Price" step="0.01" class="item-price" required>
                        <input type="text" placeholder="ISBN (optional)" class="item-isbn">
                        <button type="button" class="btn-remove" onclick="removeItem(this)">Remove</button>
                    </div>
                </div>
                <button type="button" class="btn btn-secondary btn-small" onclick="addTextbookRow()">Add Textbook</button>
            </div>
            <div class="form-group">
                <label>Supplies</label>
                <div id="suppliesContainer" class="items-container">
                    <div class="item-row">
                        <input type="text" placeholder="Supply name" class="item-name" required>
                        <input type="number" placeholder="Price" step="0.01" class="item-price" required>
                        <input type="number" placeholder="Quantity" value="1" min="1" class="item-quantity">
                        <button type="button" class="btn-remove" onclick="removeItem(this)">Remove</button>
                    </div>
                </div>
                <button type="button" class="btn btn-secondary btn-small" onclick="addSupplyRow()">Add Supply</button>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Class</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let classes = [];

async function loadClasses() {
    try {
        const response = await fetch('/api/planner/classes');
        const data = await response.json();
        if (data.success) {
            classes = data.classes;
            renderClasses();
            updateBudget();
            loadSuppliesChecklist();
        }
    } catch (error) {
        console.error('Error loading classes:', error);
    }
}

async function updateBudget() {
    try {
        const response = await fetch('/api/planner/budget');
        const data = await response.json();
        if (data.success) {
            const budget = data.budget;
            document.getElementById('totalCost').textContent = `$${budget.total_cost.toFixed(2)}`;
            document.getElementById('textbookCost').textContent = `$${budget.textbook_cost.toFixed(2)}`;
            document.getElementById('supplyCost').textContent = `$${budget.supply_cost.toFixed(2)}`;
        }
    } catch (error) {
        console.error('Error updating budget:', error);
    }
}

async function loadSuppliesChecklist() {
    // Mock supplies checklist - in real app would come from API
    const supplies = [
        { name: 'Notebooks', price: 5.00, quantity: 4 },
        { name: 'Pens & Pencils', price: 3.00, quantity: 2 },
        { name: 'Binders', price: 8.00, quantity: 2 },
        { name: 'Highlighters', price: 4.00, quantity: 1 },
        { name: 'Calculator', price: 25.00, quantity: 1 },
        { name: 'USB Drive', price: 15.00, quantity: 1 }
    ];
    
    const container = document.getElementById('suppliesChecklist');
    container.innerHTML = supplies.map(s => `
        <div class="supply-item">
            <span class="supply-name">${s.name}</span>
            <span class="supply-details">Qty: ${s.quantity} × $${s.price.toFixed(2)} = $${(s.quantity * s.price).toFixed(2)}</span>
        </div>
    `).join('');
}

function renderClasses() {
    const container = document.getElementById('classesList');
    if (classes.length === 0) {
        container.innerHTML = '<p class="empty-state">No classes added yet. Click "Add Class" to get started.</p>';
        return;
    }
    
    container.innerHTML = classes.map(cls => {
        const textbooks = cls.textbooks || [];
        const supplies = cls.supplies || [];
        const classTotal = textbooks.reduce((sum, t) => sum + parseFloat(t.price || 0), 0) +
                         supplies.reduce((sum, s) => sum + (parseFloat(s.price || 0) * parseInt(s.quantity || 1)), 0);
        
        return `
            <div class="class-card">
                <div class="class-header">
                    <div>
                        <h3>${cls.class_name}</h3>
                        <span class="semester">${cls.semester}</span>
                    </div>
                    <div class="class-actions">
                        <button class="btn-link" onclick="viewAlternatives('${cls.id}')">Find Alternatives</button>
                        <button class="btn-icon" onclick="deleteClass('${cls.id}')">Delete</button>
                    </div>
                </div>
                <div class="class-content">
                    <div class="items-group">
                        <h4>Textbooks (${textbooks.length})</h4>
                        ${textbooks.length > 0 ? textbooks.map(t => `
                            <div class="item">
                                <span class="item-name">${t.name}</span>
                                <span class="item-price">$${parseFloat(t.price || 0).toFixed(2)}</span>
                            </div>
                        `).join('') : '<p class="no-items">No textbooks</p>'}
                    </div>
                    <div class="items-group">
                        <h4>Supplies (${supplies.length})</h4>
                        ${supplies.length > 0 ? supplies.map(s => `
                            <div class="item">
                                <span class="item-name">${s.name}</span>
                                <span class="item-price">$${parseFloat(s.price || 0).toFixed(2)} × ${s.quantity || 1}</span>
                            </div>
                        `).join('') : '<p class="no-items">No supplies</p>'}
                    </div>
                    <div class="class-total">
                        <span>Class Total: $${classTotal.toFixed(2)}</span>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function showAddClassModal() {
    document.getElementById('addClassModal').style.display = 'flex';
}

function closeModal() {
    document.getElementById('addClassModal').style.display = 'none';
    document.getElementById('addClassForm').reset();
    // Reset to one row each
    document.getElementById('textbooksContainer').innerHTML = `
        <div class="item-row">
            <input type="text" placeholder="Textbook name" class="item-name" required>
            <input type="number" placeholder="Price" step="0.01" class="item-price" required>
            <input type="text" placeholder="ISBN (optional)" class="item-isbn">
            <button type="button" class="btn-remove" onclick="removeItem(this)">Remove</button>
        </div>
    `;
    document.getElementById('suppliesContainer').innerHTML = `
        <div class="item-row">
            <input type="text" placeholder="Supply name" class="item-name" required>
            <input type="number" placeholder="Price" step="0.01" class="item-price" required>
            <input type="number" placeholder="Quantity" value="1" min="1" class="item-quantity">
            <button type="button" class="btn-remove" onclick="removeItem(this)">Remove</button>
        </div>
    `;
}

function addTextbookRow() {
    const container = document.getElementById('textbooksContainer');
    const row = document.createElement('div');
    row.className = 'item-row';
    row.innerHTML = `
        <input type="text" placeholder="Textbook name" class="item-name" required>
        <input type="number" placeholder="Price" step="0.01" class="item-price" required>
        <input type="text" placeholder="ISBN (optional)" class="item-isbn">
        <button type="button" class="btn-remove" onclick="removeItem(this)">Remove</button>
    `;
    container.appendChild(row);
}

function addSupplyRow() {
    const container = document.getElementById('suppliesContainer');
    const row = document.createElement('div');
    row.className = 'item-row';
    row.innerHTML = `
        <input type="text" placeholder="Supply name" class="item-name" required>
        <input type="number" placeholder="Price" step="0.01" class="item-price" required>
        <input type="number" placeholder="Quantity" value="1" min="1" class="item-quantity">
        <button type="button" class="btn-remove" onclick="removeItem(this)">Remove</button>
    `;
    container.appendChild(row);
}

function removeItem(btn) {
    btn.parentElement.remove();
}

function viewAlternatives(classId) {
    const cls = classes.find(c => c.id === classId);
    if (!cls || !cls.textbooks || cls.textbooks.length === 0) {
        alert('No textbooks to find alternatives for');
        return;
    }
    
    // Show alternatives for first expensive textbook
    const expensiveTextbook = cls.textbooks.find(t => parseFloat(t.price || 0) > 50) || cls.textbooks[0];
    
    fetch('/api/planner/alternatives', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            textbook_name: expensiveTextbook.name,
            price: expensiveTextbook.price,
            isbn: expensiveTextbook.isbn || ''
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showAlternativesModal(expensiveTextbook.name, data.alternatives);
        }
    })
    .catch(err => console.error('Error:', err));
}

function showAlternativesModal(textbookName, alternatives) {
    // Create and show alternatives modal
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'flex';
    modal.innerHTML = `
        <div class="modal-overlay" onclick="this.closest('.modal').remove()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>Alternatives for ${textbookName}</h2>
                <button class="modal-close" onclick="this.closest('.modal').remove()">×</button>
            </div>
            <div class="alternatives-list">
                ${alternatives.map(alt => `
                    <div class="alternative-item">
                        <div class="alternative-header">
                            <h4>${alt.type}</h4>
                            <span class="alternative-price">$${alt.price.toFixed(2)}</span>
                        </div>
                        <p class="alternative-source">${alt.source}</p>
                        <div class="alternative-savings">Save $${alt.savings.toFixed(2)} (${alt.savings_percent}% off)</div>
                        ${alt.note ? `<p class="alternative-note">${alt.note}</p>` : ''}
                    </div>
                `).join('')}
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

document.getElementById('addClassForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const textbooks = Array.from(document.querySelectorAll('#textbooksContainer .item-row')).map(row => {
        const name = row.querySelector('.item-name').value;
        const price = row.querySelector('.item-price').value;
        const isbn = row.querySelector('.item-isbn')?.value || '';
        if (name && price) {
            return { name, price: parseFloat(price), isbn };
        }
        return null;
    }).filter(Boolean);
    
    const supplies = Array.from(document.querySelectorAll('#suppliesContainer .item-row')).map(row => {
        const name = row.querySelector('.item-name').value;
        const price = row.querySelector('.item-price').value;
        const quantity = row.querySelector('.item-quantity')?.value || 1;
        if (name && price) {
            return { name, price: parseFloat(price), quantity: parseInt(quantity) };
        }
        return null;
    }).filter(Boolean);
    
    const classData = {
        class_name: document.getElementById('modalClassName').value,
        semester: document.getElementById('modalSemester').value,
        textbooks,
        supplies
    };
    
    try {
        const response = await fetch('/api/planner/classes', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(classData)
        });
        
        const data = await response.json();
        if (data.success) {
            closeModal();
            loadClasses();
        } else {
            alert('Error: ' + (data.error || 'Failed to add class'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
});

async function deleteClass(classId) {
    if (!confirm('Are you sure you want to delete this class?')) return;
    
    try {
        const response = await fetch(`/api/planner/classes/${classId}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        if (data.success) {
            loadClasses();
        } else {
            alert('Error: ' + (data.error || 'Failed to delete class'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// Load on page load
loadClasses();
</script>
{% endblock %}
